from odoo import api, fields, models, _


class AccountMove(models.Model):
    _inherit = 'account.move'

    workflow_id = fields.Many2one(
        comodel_name='account.move.workflow',
        string='Generated from Workflow',
        readonly=True,
        copy=False,
        index=True,
        check_company=True
    )
    related_move_ids = fields.Many2many(
        comodel_name='account.move',
        relation='account_move_workflow_rel',
        column1='move_id',
        column2='related_move_id',
        string='Related Moves',
        help='Moves related to this one in the same workflow execution',
        readonly=True,
        copy=False
    )
    workflow_sequence = fields.Integer(
        string='Workflow Sequence',
        help='Position in the workflow execution',
        readonly=True,
        copy=False,
        index=True
    )
    
    def action_run_workflow(self):
        """Open wizard to run workflow based on this move"""
        self.ensure_one()
        
        # Only allow for posted entries
        if self.state != 'posted':
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Cannot Run Workflow'),
                    'message': _('The journal entry must be posted first.'),
                    'type': 'warning',
                    'sticky': False,
                }
            }
            
        # Do not allow executing a workflow on an entry already generated by workflow
        if self.workflow_id:
            return {
                'type': 'ir.actions.client',
                'tag': 'display_notification',
                'params': {
                    'title': _('Cannot Run Workflow'),
                    'message': _('This entry was already generated from a workflow.'),
                    'type': 'warning',
                    'sticky': False,
                }
            }
            
        return {
            'name': _('Run Workflow'),
            'type': 'ir.actions.act_window',
            'res_model': 'account.move.workflow.wizard',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_source_move_id': self.id,
                'default_company_id': self.company_id.id,
                'default_partner_id': self.partner_id.id if self.partner_id else False,
                'default_currency_id': self.currency_id.id,
                'default_amount': self.amount_total,
                'default_date': self.date,
                'default_source_move_name': self.name or '',
                'default_reference': self.ref or self.name or '',
            }
        }